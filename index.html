<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>錢老爺的帳本</title>
    <!-- 使用 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #F0F4F6;
            padding-bottom: 80px; /* 底部導航空間 */
            overscroll-behavior-y: none;
        }
        /* 自定義輸入框樣式 */
        .input-base {
            width: 100%;
            height: 46px;
            padding: 0 12px;
            background-color: #F9FAFB;
            border: 1px solid;
            border-radius: 0.75rem;
            font-size: 0.875rem; /* text-sm */
            outline: none;
            transition: all 0.2s;
        }
        .btn-base {
            height: 46px;
            border-radius: 0.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }
        .btn-base:active { transform: scale(0.96); }
        .tab-btn { transition: all 0.3s; }
        .tab-active { transform: translateY(-4px); }
        
        /* 針對 iOS 安全區域 */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        /* Toast 動畫 */
        @keyframes slideIn {
            from { transform: translateX(-50%) translateY(100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        .toast {
            animation: slideIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body>

    <!-- 頂部導航 -->
    <div id="header" class="fixed top-0 left-0 right-0 px-4 py-3 shadow-md z-20 flex justify-between items-center transition-colors duration-300 text-white safe-top">
        <div class="w-8"></div>
        <h1 class="text-base font-bold tracking-wider flex items-center gap-2" id="app-title">
            錢老爺的帳本
        </h1>
        <button onclick="openBackupModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.9-1.2-2.4-2-4.1-2a5 5 0 0 0-1.2 9.7h8.4c1.7 0 3-1.3 3-3z"/></svg>
        </button>
    </div>

    <!-- 主要內容區 -->
    <div id="main-content" class="p-4 max-w-md mx-auto mt-14 safe-top animate-fade-in">
        <!-- 內容將由 JS 動態生成 -->
    </div>

    <!-- 底部導航 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur shadow-[0_-5px_10px_rgba(0,0,0,0.03)] flex justify-around p-2 pb-6 z-50 border-t border-gray-100 safe-bottom">
        <button onclick="switchTab('boss')" class="tab-btn flex flex-col items-center w-1/3" id="tab-boss">
            <div class="w-10 h-7 rounded-2xl flex items-center justify-center mb-1 icon-container">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
            </div>
            <span class="text-[10px] font-bold text-gray-400">錢老爺</span>
        </button>
        <button onclick="switchTab('bear')" class="tab-btn flex flex-col items-center w-1/3" id="tab-bear">
            <div class="w-10 h-7 rounded-2xl flex items-center justify-center mb-1 icon-container">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <span class="text-[10px] font-bold text-gray-400">小熊</span>
        </button>
        <button onclick="switchTab('yann')" class="tab-btn flex flex-col items-center w-1/3" id="tab-yann">
            <div class="w-10 h-7 rounded-2xl flex items-center justify-center mb-1 icon-container">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <span class="text-[10px] font-bold text-gray-400">亞恩</span>
        </button>
    </div>

    <!-- Modal 容器 -->
    <div id="modal-container"></div>
    
    <!-- Toast 容器 -->
    <div id="toast-container" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[60]"></div>

    <script>
        // --- 設定 ---
        const DAILY_WAGE = 3000;
        
        const THEMES = {
            boss: { name: '錢老爺', primary: 'bg-[#6D8B98]', secondary: 'bg-[#A6BCC5]', textLight: 'text-[#546E7A]', border: 'border-[#CFD8DC]', stat1: 'bg-[#7A9D96]', stat2: 'bg-[#C68686]', text1: 'text-[#7A9D96]', text2: 'text-[#C68686]' },
            bear: { name: '小熊', primary: 'bg-[#7D9D9C]', secondary: 'bg-[#A6C0BE]', textLight: 'text-[#5F7A7A]', border: 'border-[#CADEDD]', stat1: 'bg-[#8FBC8F]', stat2: 'bg-[#BC8F8F]', text1: 'text-[#7D9D9C]', text2: 'text-[#BC8F8F]' },
            yann: { name: '亞恩', primary: 'bg-[#B58B8B]', secondary: 'bg-[#D6BDBD]', textLight: 'text-[#8D6E63]', border: 'border-[#E6D0D0]', stat1: 'bg-[#CD853F]', stat2: 'bg-[#D4A5A5]', text1: 'text-[#B58B8B]', text2: 'text-[#D4A5A5]' }
        };

        // --- 狀態 ---
        let state = {
            tab: 'boss',
            month: new Date().toISOString().slice(0, 7),
            bossForm: { type: 'income', amount: '', category: '工地支出', note: '', date: new Date().toISOString().slice(0, 10) },
            workerForm: { type: 'work', days: '', amount: '', note: '', date: new Date().toISOString().slice(0, 10) },
            data: {
                bossRecords: JSON.parse(localStorage.getItem('bossRecords')) || [],
                expenseCategories: JSON.parse(localStorage.getItem('expenseCategories')) || ['工地支出', '工錢支出'],
                workers: JSON.parse(localStorage.getItem('workers')) || { bear: { records: [] }, yann: { records: [] } }
            }
        };

        // --- 初始化與渲染 ---
        function init() {
            render();
        }

        function saveData() {
            localStorage.setItem('bossRecords', JSON.stringify(state.data.bossRecords));
            localStorage.setItem('expenseCategories', JSON.stringify(state.data.expenseCategories));
            localStorage.setItem('workers', JSON.stringify(state.data.workers));
            render(); // Re-render to update UI
        }

        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg text-sm mb-2 text-center whitespace-nowrap';
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function switchTab(tab) {
            state.tab = tab;
            // 重置表單狀態當切換時
            const today = new Date().toISOString().slice(0, 10);
            state.bossForm = { type: 'income', amount: '', category: '工地支出', note: '', date: today };
            state.workerForm = { type: 'work', days: '', amount: '', note: '', date: today };
            render();
        }

        function render() {
            const theme = THEMES[state.tab];
            
            // 1. 更新 Header
            const header = document.getElementById('header');
            header.className = `fixed top-0 left-0 right-0 px-4 py-3 shadow-md z-20 flex justify-between items-center transition-colors duration-300 text-white safe-top ${theme.primary}`;
            document.getElementById('app-title').innerHTML = `
                ${state.tab === 'boss' ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>' : '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'}
                ${theme.name}的帳本
            `;

            // 2. 更新底部導航樣式
            ['boss', 'bear', 'yann'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const iconContainer = btn.querySelector('.icon-container');
                const text = btn.querySelector('span');
                
                if (t === state.tab) {
                    btn.classList.add('tab-active');
                    iconContainer.className = `w-10 h-7 rounded-2xl flex items-center justify-center mb-1 icon-container text-white shadow-lg shadow-gray-300 ${THEMES[t].primary}`;
                    text.className = `text-[10px] font-bold ${THEMES[t].textLight}`;
                } else {
                    btn.classList.remove('tab-active');
                    iconContainer.className = `w-10 h-7 rounded-2xl flex items-center justify-center mb-1 icon-container text-gray-400`;
                    text.className = `text-[10px] font-bold text-gray-400`;
                }
            });

            // 3. 生成主要內容
            const content = document.getElementById('main-content');
            
            // 篩選資料
            let records = [];
            let stats = {};
            
            if (state.tab === 'boss') {
                records = state.data.bossRecords.filter(r => r.date.startsWith(state.month)).sort((a,b) => new Date(b.date) - new Date(a.date));
                const income = records.filter(r => r.type === 'income').reduce((acc, c) => acc + c.amount, 0);
                const expense = records.filter(r => r.type === 'expense').reduce((acc, c) => acc + c.amount, 0);
                stats = { title: '結算餘額', balance: income - expense, sub1: '本月入帳', val1: income, sub2: '本月支出', val2: expense };
            } else {
                const workerKey = state.tab;
                records = state.data.workers[workerKey].records.filter(r => r.date.startsWith(state.month)).sort((a,b) => new Date(b.date) - new Date(a.date));
                const days = records.filter(r => r.type === 'work').reduce((acc, c) => acc + c.days, 0);
                const earned = records.filter(r => r.type === 'work').reduce((acc, c) => acc + c.amount, 0);
                const taken = records.filter(r => r.type === 'payment').reduce((acc, c) => acc + c.amount, 0);
                stats = { title: '應付結算', balance: earned - taken, sub1: '本月工資', val1: earned, sub2: '本月已領', val2: taken, sub3: '工數', val3: days };
            }

            let html = `
                <!-- 月份選擇器 -->
                <div class="flex items-center justify-between bg-white px-2 py-1.5 rounded-xl shadow-sm border border-gray-100 mb-4 h-[44px]">
                    <button onclick="changeMonth(-1)" class="p-1.5 rounded-lg hover:bg-gray-100 text-gray-500"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                    <div class="flex items-center gap-2 font-bold text-base text-gray-700 relative">
                        <svg class="w-4 h-4 ${theme.textLight}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        <span>${state.month.replace('-', '年 ')}月</span>
                        <input type="month" value="${state.month}" onchange="setMonth(this.value)" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer">
                    </div>
                    <button onclick="changeMonth(1)" class="p-1.5 rounded-lg hover:bg-gray-100 text-gray-500"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                </div>

                <!-- 餘額卡片 -->
                <div class="rounded-2xl p-4 shadow-lg text-white mb-4 ${theme.primary}">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs font-medium opacity-90 tracking-wider">${state.month.split('-')[1]}月 ${stats.title}</span>
                        <svg class="w-4 h-4 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                    </div>
                    <div class="text-3xl font-extrabold mb-4 tracking-tight">$${stats.balance.toLocaleString()}</div>
                    <div class="flex gap-2">
                        <div class="flex-1 bg-black/10 rounded-lg p-2 backdrop-blur-sm min-w-0 overflow-hidden">
                            <p class="text-[10px] opacity-80 mb-0.5 truncate">${stats.sub1}</p>
                            <p class="text-base font-bold truncate">$${stats.val1.toLocaleString()}</p>
                        </div>
                        <div class="flex-1 bg-black/10 rounded-lg p-2 backdrop-blur-sm min-w-0 overflow-hidden">
                            <p class="text-[10px] opacity-80 mb-0.5 truncate">${stats.sub2}</p>
                            <p class="text-base font-bold truncate">$${stats.val2.toLocaleString()}</p>
                        </div>
                         ${stats.sub3 ? `<div class="flex-1 bg-black/10 rounded-lg p-2 backdrop-blur-sm min-w-0 overflow-hidden"><p class="text-[10px] opacity-80 mb-0.5 truncate">${stats.sub3}</p><p class="text-base font-bold truncate">${stats.val3} 工</p></div>` : ''}
                    </div>
                </div>

                <!-- 輸入表單區塊 -->
                <div class="bg-white rounded-2xl p-4 shadow-sm border ${theme.border} mb-6">
                    <div class="flex bg-gray-100 p-1 rounded-xl mb-4">
                        ${state.tab === 'boss' ? `
                            <button onclick="setFormType('income')" class="flex-1 h-[36px] text-sm font-bold rounded-lg transition-all ${state.bossForm.type === 'income' ? 'bg-white shadow text-[#37474F]' : 'text-gray-400'}">資金入帳</button>
                            <button onclick="setFormType('expense')" class="flex-1 h-[36px] text-sm font-bold rounded-lg transition-all ${state.bossForm.type === 'expense' ? 'bg-white shadow text-[#37474F]' : 'text-gray-400'}">支出紀錄</button>
                        ` : `
                            <button onclick="setFormType('work')" class="flex-1 h-[36px] text-sm font-bold rounded-lg transition-all ${state.workerForm.type === 'work' ? 'bg-white shadow text-[#37474F]' : 'text-gray-400'}">記工 (賺錢)</button>
                            <button onclick="setFormType('payment')" class="flex-1 h-[36px] text-sm font-bold rounded-lg transition-all ${state.workerForm.type === 'payment' ? 'bg-white shadow text-[#C68686]' : 'text-gray-400'}">領錢 (支出)</button>
                        `}
                    </div>

                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-5 items-end">
                            <div>
                                <label class="block text-xs font-bold mb-1 ml-1 ${theme.textLight}">日期</label>
                                <input type="date" value="${state.tab === 'boss' ? state.bossForm.date : state.workerForm.date}" onchange="updateForm('date', this.value)" class="input-base ${theme.border} text-sm">
                            </div>
                            <div>
                                ${state.tab !== 'boss' && state.workerForm.type === 'work' ? `
                                    <label class="block text-xs font-bold mb-1 ml-1 ${theme.textLight}">工數</label>
                                    <input type="number" inputmode="decimal" step="0.5" placeholder="0.0" value="${state.workerForm.days}" oninput="updateForm('days', this.value)" class="input-base ${theme.border} text-sm">
                                ` : `
                                    <label class="block text-xs font-bold mb-1 ml-1 ${theme.textLight}">金額</label>
                                    <input type="number" inputmode="decimal" placeholder="輸入金額" value="${state.tab === 'boss' ? state.bossForm.amount : state.workerForm.amount}" oninput="updateForm('amount', this.value)" class="input-base ${theme.border} text-sm">
                                `}
                            </div>
                        </div>

                         ${state.tab !== 'boss' && state.workerForm.type === 'work' ? `
                            <div class="h-[46px] bg-gray-50 border border-dashed border-gray-300 rounded-xl flex items-center justify-center">
                                <span class="text-gray-400 text-xs mr-1">=</span>
                                <span class="font-bold text-base text-gray-700">$${state.workerForm.amount ? Number(state.workerForm.amount).toLocaleString() : '0'}</span>
                            </div>
                         ` : ''}

                        ${state.tab === 'boss' && state.bossForm.type === 'expense' ? `
                             <div class="flex gap-3">
                                <div class="relative w-full">
                                    <label class="block text-xs font-bold mb-1 ml-1 ${theme.textLight}">支出分類</label>
                                    <select onchange="updateForm('category', this.value)" class="input-base ${theme.border} text-sm appearance-none">
                                        ${state.data.expenseCategories.map(c => `<option value="${c}" ${state.bossForm.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                                    </select>
                                    <div class="absolute right-3 top-[34px] pointer-events-none opacity-50">▼</div>
                                </div>
                                <div class="flex flex-col justify-end">
                                    <button onclick="openCategoryModal()" class="h-[46px] w-[46px] flex items-center justify-center border border-gray-300 rounded-xl text-gray-500 hover:bg-gray-50 active:scale-95">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                    </button>
                                </div>
                            </div>
                        ` : ''}

                        <div>
                            <label class="block text-xs font-bold mb-1 ml-1 ${theme.textLight}">備註</label>
                            <input type="text" placeholder="備註說明..." value="${state.tab === 'boss' ? state.bossForm.note : state.workerForm.note}" oninput="updateForm('note', this.value)" class="input-base ${theme.border} text-sm">
                        </div>

                        <button onclick="submitForm()" class="btn-base w-full text-white text-base shadow-md ${state.tab === 'boss' ? (state.bossForm.type === 'income' ? theme.primary : 'bg-[#C68686]') : (state.workerForm.type === 'work' ? theme.primary : 'bg-[#C68686]') }">
                            ${state.tab === 'boss' ? (state.bossForm.type === 'income' ? '確認入帳' : '確認支出') : (state.workerForm.type === 'work' ? '確認記工' : '確認領款')}
                        </button>
                    </div>
                </div>

                <!-- 列表 -->
                <div class="space-y-3 pb-4">
                    ${records.length === 0 ? '<p class="text-center text-gray-400 py-4 text-sm">本月尚無紀錄</p>' : 
                        records.map(rec => `
                            <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center">
                                <div class="flex items-center gap-3 min-w-0">
                                    <div class="shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-white text-[10px] font-bold ${rec.type === 'income' || rec.type === 'work' ? theme.stat1 : theme.stat2}">
                                        ${rec.date.slice(5).replace('-', '/')}
                                    </div>
                                    <div class="min-w-0 truncate">
                                        <p class="font-bold text-gray-700 text-sm truncate">
                                            ${state.tab === 'boss' ? (rec.type === 'income' ? '資金入帳' : rec.category) : (rec.type === 'work' ? `出工 ${rec.days} 天` : '領錢')}
                                        </p>
                                        <p class="text-xs text-gray-400 truncate">${rec.note || (rec.type === 'work' ? '一般出工' : '預支')}</p>
                                    </div>
                                </div>
                                <div class="text-right shrink-0">
                                    <p class="font-bold text-base ${rec.type === 'income' || rec.type === 'work' ? theme.text1 : theme.text2}">
                                        ${rec.type === 'income' || rec.type === 'work' ? '+' : '-'}$${Number(rec.amount).toLocaleString()}
                                    </p>
                                    <button onclick="deleteRecord(${rec.id})" class="text-xs text-gray-300 p-1">刪除</button>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
            `;
            content.innerHTML = html;
        }

        // --- 邏輯函數 ---
        function changeMonth(offset) {
            const [y, m] = state.month.split('-');
            const date = new Date(parseInt(y), parseInt(m) - 1 + offset, 1);
            const newY = date.getFullYear();
            const newM = String(date.getMonth() + 1).padStart(2, '0');
            state.month = `${newY}-${newM}`;
            render();
        }

        function setMonth(val) {
            if(val) {
                state.month = val;
                render();
            }
        }

        function setFormType(type) {
            if (state.tab === 'boss') state.bossForm.type = type;
            else state.workerForm.type = type;
            render();
        }

        function updateForm(field, value) {
            if (state.tab === 'boss') {
                state.bossForm[field] = value;
            } else {
                state.workerForm[field] = value;
                if (field === 'days') {
                    state.workerForm.amount = value ? (parseFloat(value) * DAILY_WAGE) : '';
                }
            }
            if (field === 'days' && state.tab !== 'boss') {
               render();
            }
        }
        
        function submitForm() {
            if (state.tab === 'boss') {
                // Boss 邏輯
                if (!state.bossForm.amount) return;
                const newRec = { id: Date.now(), ...state.bossForm, amount: parseFloat(state.bossForm.amount) };
                state.data.bossRecords.push(newRec);
                state.bossForm.amount = ''; state.bossForm.note = '';
            } else {
                // Worker 邏輯
                if ((state.workerForm.type === 'work' && !state.workerForm.days) || (state.workerForm.type === 'payment' && !state.workerForm.amount)) return;
                
                // 1. 新增工人紀錄
                const newRec = {
                    id: Date.now(),
                    date: state.workerForm.date,
                    type: state.workerForm.type,
                    note: state.workerForm.note,
                    days: state.workerForm.type === 'work' ? parseFloat(state.workerForm.days) : 0,
                    amount: state.workerForm.type === 'work' ? parseFloat(state.workerForm.days) * DAILY_WAGE : parseFloat(state.workerForm.amount)
                };
                state.data.workers[state.tab].records.push(newRec);

                // 2. 自動同步：如果是領錢，自動幫錢老爺記一筆支出
                if (state.workerForm.type === 'payment') {
                    const workerName = THEMES[state.tab].name;
                    const bossRec = {
                        id: Date.now() + 1, // 避免 ID 重複
                        date: state.workerForm.date,
                        type: 'expense',
                        category: '工錢支出',
                        amount: parseFloat(state.workerForm.amount),
                        note: `${workerName}領錢${state.workerForm.note ? ' (' + state.workerForm.note + ')' : ''}`
                    };
                    state.data.bossRecords.push(bossRec);
                    showToast(`已自動同步至錢老爺帳本：${workerName}領錢`);
                }

                state.workerForm.days = ''; state.workerForm.amount = ''; state.workerForm.note = '';
            }
            saveData();
        }

        function deleteRecord(id) {
            if(!confirm('確定要刪除這筆紀錄嗎？')) return;
            if (state.tab === 'boss') {
                state.data.bossRecords = state.data.bossRecords.filter(r => r.id !== id);
            } else {
                state.data.workers[state.tab].records = state.data.workers[state.tab].records.filter(r => r.id !== id);
            }
            saveData();
        }

        // --- Modal 邏輯 ---
        function openBackupModal() {
            const json = JSON.stringify(state.data);
            const encoded = btoa(unescape(encodeURIComponent(json)));
            const html = `
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4" onclick="this.remove()">
                    <div class="bg-white rounded-2xl w-full max-w-sm p-5 shadow-2xl" onclick="event.stopPropagation()">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">雲端資料同步</h3>
                        <div class="space-y-4">
                            <p class="text-sm text-gray-500">複製下方代碼到新手機還原：</p>
                            <div class="bg-gray-50 p-3 rounded-xl border text-xs break-all h-24 overflow-y-auto select-all">${encoded}</div>
                            <textarea id="restoreInput" placeholder="在此貼上代碼還原..." class="w-full h-24 p-2 border rounded-xl text-xs"></textarea>
                            <div class="flex gap-2">
                                <button onclick="this.closest('.fixed').remove()" class="flex-1 py-2 border rounded-xl font-bold text-gray-500">關閉</button>
                                <button onclick="restoreData()" class="flex-1 py-2 bg-[#C68686] text-white rounded-xl font-bold">還原資料</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').innerHTML = html;
        }

        function restoreData() {
            try {
                const input = document.getElementById('restoreInput').value;
                if(!input) return alert('請輸入代碼');
                const json = decodeURIComponent(escape(atob(input)));
                const data = JSON.parse(json);
                if(data.bossRecords && data.workers) {
                    state.data = data;
                    saveData();
                    document.getElementById('modal-container').innerHTML = '';
                    alert('還原成功！');
                } else {
                    alert('格式錯誤');
                }
            } catch(e) {
                alert('無效的代碼');
            }
        }

        function openCategoryModal() {
            const html = `
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4" onclick="this.remove()">
                     <div class="bg-white rounded-2xl w-full max-w-sm p-5 shadow-2xl" onclick="event.stopPropagation()">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">管理分類</h3>
                        <div class="flex gap-2 mb-4">
                            <input id="newCatInput" class="flex-1 border rounded-xl px-2" placeholder="新增分類">
                            <button onclick="addCategory()" class="bg-gray-700 text-white px-4 rounded-xl font-bold">新增</button>
                        </div>
                        <div class="max-h-60 overflow-y-auto space-y-2">
                            ${state.data.expenseCategories.map(c => `
                                <div class="flex justify-between p-2 bg-gray-50 rounded-lg">
                                    <span>${c}</span>
                                    <button onclick="delCategory('${c}')" class="text-red-400">刪除</button>
                                </div>
                            `).join('')}
                        </div>
                     </div>
                </div>
            `;
            document.getElementById('modal-container').innerHTML = html;
        }

        function addCategory() {
            const val = document.getElementById('newCatInput').value;
            if(val) {
                state.data.expenseCategories.push(val);
                saveData();
                openCategoryModal(); // Re-render modal
            }
        }

        function delCategory(c) {
            if(confirm('刪除?')) {
                state.data.expenseCategories = state.data.expenseCategories.filter(cat => cat !== c);
                saveData();
                openCategoryModal();
            }
        }

        // 啟動
        init();
    </script>
</body>
</html>


